{% extends "base.html" %}
{% set title = client.name %}

{% block content %}

<div class="topbar">
  <h1>Trainer App</h1>
  <div class="actions">
    <a href="{{ url_for('index') }}" class="btn secondary">Back to Dashboard</a>
    <a href="{{ url_for('logout') }}" class="btn danger">Log out</a>
  </div>
</div>

<div class="card">
  <h2 style="margin:0 0 6px 0;">{{ client.name }}</h2>

  <div class="muted">
    Phone: {{ client.phone or "-" }}
    | Plan: {{ client.plan or "-" }}
    | {{ sessions_per_week or 0 }}/week
    {% if bonus and bonus > 0 %} | rollover: {{ bonus }} {% endif %}
  </div>

  {% if current_status %}
    <div class="muted" style="margin-top:8px;">
      Status:
      <span class="payment-badge payment-badge-{{ payment_status_tone }}">{{ payment_status_label }}</span>
      |
      Paid: {{ current_status.amount_paid }} MKD
      | Start: {{ current_status.start_date.strftime("%d/%m/%Y") }}
      | Months: {{ current_status.months }}
      | Paid until: {{ current_status.paid_until.strftime("%d/%m/%Y") }}
      | Days left:
      {% if current_status.days_left >= 0 %}
        <b style="color:var(--success);">{{ current_status.days_left }}</b>
      {% else %}
        <b style="color:var(--danger);">OVERDUE {{ (-current_status.days_left) }}</b>
      {% endif %}
    </div>
  {% endif %}
</div>

<div class="card">
  <h3>Client Summary</h3>
  <div class="stats-grid">
    <div><b>Sessions Left</b><div class="muted">{{ remaining }} / {{ allowed }} this week</div></div>
    <div><b>Total Sessions</b><div class="muted">{{ total_sessions }}</div></div>
    <div><b>Weight Change</b><div class="muted">
      {% if weight_change is not none %}
        {{ weight_change }} kg
      {% else %}
        -
      {% endif %}
    </div></div>
  </div>
  <div class="muted" style="margin-top:10px;">
    Milestones: {{ milestones|join(" | ") }}
  </div>
  <div class="actions" style="margin-top:12px;">
    <a class="btn secondary" href="{{ url_for('client_profile', client_id=client.id, tab='sessions') }}#logSessionForm">Quick Log Session</a>
    <a class="btn secondary" href="{{ url_for('client_profile', client_id=client.id, tab='stats') }}#statsEntryForm">Quick Add Weight</a>
    {% if is_admin %}
      <a class="btn secondary" href="{{ url_for('client_profile', client_id=client.id, tab='payments') }}#paymentEntryForm">Quick Add Payment</a>
    {% endif %}
    <a class="btn secondary" href="{{ url_for('export_client_report_pdf', client_id=client.id) }}">Download Report PDF</a>
  </div>
</div>

{% if err %}
  <div class="card alert error">
    <b style="color:var(--danger);">Error:</b> {{ err }}
  </div>
{% endif %}

{% if msg %}
  <div class="card alert success">
    <b style="color:var(--success);">OK:</b> {{ msg }}
  </div>
{% endif %}

{% if must_change_password and not is_admin %}
  <div class="card alert error">
    <b style="color:var(--danger);">Action required:</b> Set a new password in the Info tab before using other tabs.
  </div>
{% endif %}

<div class="tabs">
  <a class="tab {% if tab=='info' %}active{% endif %}" href="{{ url_for('client_profile', client_id=client.id, tab='info') }}">
     Info
  </a>
  <a class="tab {% if tab=='stats' %}active{% endif %}" href="{{ url_for('client_profile', client_id=client.id, tab='stats') }}">
     Stats
  </a>
  <a class="tab {% if tab=='sessions' %}active{% endif %}" href="{{ url_for('client_profile', client_id=client.id, tab='sessions') }}">
     Sessions
  </a>
  {% if is_admin %}
    <a class="tab {% if tab=='payments' %}active{% endif %}" href="{{ url_for('client_profile', client_id=client.id, tab='payments') }}">
       Payments
    </a>
  {% endif %}
</div>

{% if tab == "info" %}
  {% include "tabs/info.html" %}
{% elif tab == "stats" %}
  {% include "tabs/stats.html" %}
{% elif tab == "sessions" %}
  {% include "tabs/sessions.html" %}
{% elif tab == "payments" and is_admin %}
  {% include "tabs/payments.html" %}
{% endif %}

<script>
  (function () {
    if (localStorage.getItem("trainer_client_onboarding_seen") === "1") return;
    const showOnTabs = ["info", "stats", "sessions"];
    const current = "{{ tab }}";
    if (showOnTabs.indexOf(current) === -1) return;
    const modal = document.getElementById("onboardingModal");
    if (!modal) return;
    window.setTimeout(function () {
      modal.classList.add("show");
    }, 350);

    const closeButtons = modal.querySelectorAll("[data-close-onboarding]");
    closeButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        modal.classList.remove("show");
        localStorage.setItem("trainer_client_onboarding_seen", "1");
      });
    });
  })();
</script>

<div id="onboardingModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card">
    <h3 style="margin-bottom:8px;">Quick Tips</h3>
    <div class="muted">
      Use Quick Add buttons for faster updates. Keep weight entries consistent for better graph tracking.
    </div>
    <div class="actions" style="margin-top:14px;">
      <button class="btn" type="button" data-close-onboarding>Got it</button>
      <button class="btn secondary" type="button" data-close-onboarding>Close</button>
    </div>
  </div>
</div>

{% endblock %}
