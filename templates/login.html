{% extends "base.html" %}
{% set title = "Login | Trainer App" %}
{% set page_class = "page-login" %}

{% block content %}
<div class="login-split">
  <section class="auth-visual auth-visual-full" style="--auth-photo:url('{{ url_for('static', filename='images/coach.png') }}');">
    <div class="auth-visual-inner">
      <h2 class="auth-title">Train. Track. Improve.</h2>
      <p class="muted" style="max-width:30ch;">
        Keep progress, sessions, and payment status in one clean system.
      </p>
      <div class="auth-metrics">
        <div class="auth-chip">Sessions</div>
        <div class="auth-chip">Progress</div>
        <div class="auth-chip">Consistency</div>
      </div>
      <div class="auth-socials">
        <a class="auth-social auth-social-icon" href="https://www.instagram.com/dame.17/?hl=en" target="_blank" rel="noopener noreferrer" aria-label="Instagram" title="Instagram">
          <img src="{{ url_for('static', filename='images/social/instagram.png') }}" alt="Instagram">
        </a>
        <a class="auth-social auth-social-icon" href="https://www.facebook.com/damjan.atanasovski.96/" target="_blank" rel="noopener noreferrer" aria-label="Facebook" title="Facebook">
          <img src="{{ url_for('static', filename='images/social/facebook.png') }}" alt="Facebook">
        </a>
        <button
          class="auth-social auth-social-icon"
          type="button"
          id="viberCopyButton"
          data-copy-number="+38979249666"
          aria-label="Copy Viber number"
          title="Copy Viber number"
        >
          <img src="{{ url_for('static', filename='images/social/viber.png') }}" alt="Viber">
        </button>
      </div>
      <div id="copyToast" class="copy-toast" role="status" aria-live="polite"></div>
    </div>
  </section>

  <section class="login-panel">
    <div class="login-panel-inner">
      <div class="login-card">
        <h2 class="auth-title">Client Login</h2>
        <p class="muted" style="margin-top:0;">Enter your username and password.</p>

        {% if err %}
          <div class="alert error" style="margin-top:12px;">
            <b style="color:var(--danger);">Error:</b>
            {% if lock_seconds %}
              Too many attempts. Try again in <span id="lock-seconds" data-seconds="{{ lock_seconds }}">{{ lock_seconds }}</span>s.
            {% else %}
              {{ err }}
            {% endif %}
          </div>
        {% endif %}

        <form class="form" action="{{ url_for('login') }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label class="label">Username</label>
          <input class="input" name="username" autocomplete="username" required {% if lock_seconds %}disabled{% endif %}>

          <label class="label">Password</label>
          <div class="password-wrap">
            <input id="loginPassword" class="input" type="password" name="password" autocomplete="current-password" required {% if lock_seconds %}disabled{% endif %}>
            <button
              id="loginPasswordToggle"
              class="password-toggle"
              type="button"
              data-password-target="loginPassword"
              aria-label="Show password"
              aria-pressed="false"
              {% if lock_seconds %}disabled{% endif %}
            >&#128065;</button>
          </div>

          <button class="btn" type="submit" style="margin-top:6px;" {% if lock_seconds %}disabled{% endif %}>Log in</button>
        </form>

        <div class="muted auth-foot">
          If you do not have credentials, ask your coach.
        </div>
      </div>
    </div>
  </section>
</div>
<script>
  (function () {
    const copyBtn = document.getElementById("viberCopyButton");
    const copyToast = document.getElementById("copyToast");
    if (copyBtn && copyToast) {
      const number = copyBtn.dataset.copyNumber || "";
      function showToast(message) {
        copyToast.textContent = message;
        copyToast.classList.add("show");
        window.setTimeout(() => copyToast.classList.remove("show"), 1800);
      }
      copyBtn.addEventListener("click", async function () {
        if (!number) return;
        try {
          await navigator.clipboard.writeText(number);
          showToast("Viber copied: " + number);
        } catch (e) {
          showToast("Copy failed. Number: " + number);
        }
      });
    }

    const el = document.getElementById("lock-seconds");
    if (!el) return;
    const form = el.closest(".login-card")?.querySelector("form");
    const fields = form ? form.querySelectorAll("input[name='username'], input[name='password'], button[type='submit'], #loginPasswordToggle") : [];
    let seconds = Number(el.dataset.seconds || 0);
    if (!Number.isFinite(seconds) || seconds <= 0) return;
    const timer = setInterval(() => {
      seconds -= 1;
      if (seconds <= 0) {
        el.textContent = "0";
        fields.forEach((field) => { field.disabled = false; });
        clearInterval(timer);
        return;
      }
      el.textContent = String(seconds);
    }, 1000);
  })();
</script>
{% endblock %}
