<div class="card">
  <h3>Client Info</h3>

  {% if is_admin %}
    <form class="form" action="{{ url_for('update_client_admin', client_id=client.id) }}" method="POST" style="max-width:700px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label class="label">Name</label>
      <input class="input" name="name" value="{{ client.name }}" required>

      <label class="label" style="margin-top:12px;">Phone</label>
      <input class="input" name="phone" value="{{ client.phone or '' }}" inputmode="tel" pattern="\+?\d*" title="Use only digits and optional leading +">

      <label class="label" style="margin-top:12px;">Plan</label>
      <input class="input" name="plan" value="{{ client.plan or '' }}">

      <label class="label" style="margin-top:12px;">Current sessions per week (from payments)</label>
      <input class="input" value="{{ sessions_per_week or 0 }}" disabled>

      <label class="label" style="margin-top:12px;">Fallback sessions per week (used if no payments exist)</label>
      <input class="input" type="number" name="weekly" min="0" value="{{ client.weekly_sessions or 0 }}">

      <button class="btn" type="submit" style="margin-top:14px;">Save Info</button>
    </form>

    <hr class="sep">

    {% if not client_user %}
      <h3>Create Client Login</h3>
      <form class="form" action="{{ url_for('create_client_login', client_id=client.id) }}" method="POST" style="max-width:700px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label class="label">Username</label>
        <input class="input" name="username" required>

        <label class="label">Temporary Password</label>
        <div class="password-wrap">
          <input id="createClientPassword" class="input" name="password" type="password" required>
          <button class="password-toggle" type="button" data-password-target="createClientPassword" aria-label="Show password" aria-pressed="false">&#128065;</button>
        </div>

        <button class="btn" type="submit">Create Login</button>
      </form>

      <p class="muted" style="margin-top:10px;">
        Give these credentials to the client. They can log in at <b>/login</b>.
      </p>
    {% else %}
      <h3>Client Login</h3>
      <div class="muted">
        Username: <b>{{ client_user.username }}</b> |
        Status:
        {% if client_user.role == "disabled" %}
          <b style="color:var(--danger);">Deactivated</b>
        {% else %}
          <b style="color:var(--success);">Active</b>
        {% endif %}
      </div>

      <form class="form" action="{{ url_for('admin_reset_client_password', client_id=client.id) }}" method="POST" style="max-width:700px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label class="label">New temporary password</label>
        <div class="password-wrap">
          <input id="resetClientPassword" class="input" name="new_password" type="password" required>
          <button class="password-toggle" type="button" data-password-target="resetClientPassword" aria-label="Show password" aria-pressed="false">&#128065;</button>
        </div>
        <button class="btn" type="submit">Reset Password</button>
      </form>

      <div class="actions" style="margin-top:8px;">
        {% if client_user.role == "disabled" %}
          <form action="{{ url_for('reactivate_client_login', client_id=client.id) }}" method="POST" style="margin:0;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn" type="submit">Reactivate Login</button>
          </form>
        {% else %}
          <form action="{{ url_for('deactivate_client_login', client_id=client.id) }}" method="POST" style="margin:0;"
                onsubmit="return confirm('Deactivate this client login?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn danger" type="submit">Deactivate Login</button>
          </form>
        {% endif %}
      </div>
    {% endif %}

  {% else %}
    <div class="muted" style="margin-bottom:10px;">
      You can only edit your phone number. Contact your coach for other changes.
    </div>

    <form class="form" action="{{ url_for('update_client_phone', client_id=client.id) }}" method="POST" style="max-width:700px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label class="label">Name</label>
      <input class="input" value="{{ client.name }}" disabled>

      <label class="label" style="margin-top:12px;">Phone</label>
      <input class="input" name="phone" value="{{ client.phone or '' }}" inputmode="tel" pattern="\+?\d+" title="Use only digits and optional leading +" required>

      <label class="label" style="margin-top:12px;">Plan</label>
      <input class="input" value="{{ client.plan or '-' }}" disabled>

      <label class="label" style="margin-top:12px;">Sessions per week</label>
      <input class="input" value="{{ sessions_per_week or 0 }}" disabled>

      <button class="btn" type="submit" style="margin-top:14px;">Save Phone</button>
    </form>

    <hr class="sep">

    <h3>Change Password</h3>
    <form class="form" action="{{ url_for('change_client_password', client_id=client.id) }}" method="POST" style="max-width:700px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label class="label">Current password</label>
      <div class="password-wrap">
        <input id="clientCurrentPassword" class="input" type="password" name="current_password" autocomplete="current-password" required>
        <button class="password-toggle" type="button" data-password-target="clientCurrentPassword" aria-label="Show password" aria-pressed="false">&#128065;</button>
      </div>

      <label class="label">New password</label>
      <div class="password-wrap">
        <input id="clientNewPassword" class="input" type="password" name="new_password" autocomplete="new-password" required>
        <button class="password-toggle" type="button" data-password-target="clientNewPassword" aria-label="Show password" aria-pressed="false">&#128065;</button>
      </div>

      <label class="label">Confirm new password</label>
      <div class="password-wrap">
        <input id="clientConfirmPassword" class="input" type="password" name="confirm_password" autocomplete="new-password" required>
        <button class="password-toggle" type="button" data-password-target="clientConfirmPassword" aria-label="Show password" aria-pressed="false">&#128065;</button>
      </div>

      <button class="btn" type="submit" style="margin-top:14px;">Update Password</button>
    </form>
  {% endif %}

  <hr class="sep">

  <h3>Goals</h3>
  {% if is_admin %}
    <form class="form" action="{{ url_for('add_client_goal', client_id=client.id) }}" method="POST" style="max-width:700px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label class="label">Goal title</label>
      <input class="input" name="title" maxlength="120" placeholder="e.g. Lose 4kg by summer" required>

      <div class="grid-2">
        <div>
          <label class="label">Target value (optional)</label>
          <input class="input" name="target_value" type="number" step="0.1" placeholder="e.g. 75">
        </div>
        <div>
          <label class="label">Current value (optional)</label>
          <input class="input" name="current_value" type="number" step="0.1" placeholder="e.g. 81">
        </div>
      </div>

      <label class="label">Target date (optional)</label>
      <input class="input" name="target_date" type="date">

      <label class="label">Note</label>
      <input class="input" name="note" maxlength="300" placeholder="Optional details...">
      <button class="btn" type="submit">Add Goal</button>
    </form>
  {% endif %}

  {% if goals %}
    <div class="table-wrap" style="margin-top:10px;">
      <table>
        <tr>
          <th>Goal</th>
          <th>Progress</th>
          <th>Target Date</th>
          <th>Status</th>
          <th>Note</th>
          <th></th>
        </tr>
        {% for g in goals %}
          <tr>
            <td>{{ g.title }}</td>
            <td>
              {{ g.current_value if g.current_value is not none else "-" }}
              /
              {{ g.target_value if g.target_value is not none else "-" }}
            </td>
            <td>{{ g.target_date.strftime("%d/%m/%Y") if g.target_date else "-" }}</td>
            <td>{{ g.status }}</td>
            <td>{{ g.note or "-" }}</td>
            <td style="text-align:right;">
              {% if is_admin %}
                <form action="{{ url_for('update_client_goal', client_id=client.id, goal_id=g.id) }}" method="POST" style="display:flex; gap:6px; align-items:center; margin:0 0 6px 0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input class="input" type="number" step="0.1" name="current_value" placeholder="Current" style="max-width:96px;">
                  <select class="input" name="status" style="max-width:120px;">
                    <option value="active" {% if g.status=='active' %}selected{% endif %}>active</option>
                    <option value="completed" {% if g.status=='completed' %}selected{% endif %}>completed</option>
                    <option value="paused" {% if g.status=='paused' %}selected{% endif %}>paused</option>
                  </select>
                  <button class="btn secondary" type="submit">Update</button>
                </form>
                <form action="{{ url_for('delete_client_goal', client_id=client.id, goal_id=g.id) }}" method="POST" onsubmit="return confirm('Delete this goal?');" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn danger" type="submit">Delete</button>
                </form>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
  {% else %}
    <div class="empty-state" style="margin-top:10px;">No goals set yet.</div>
  {% endif %}

  <hr class="sep">

  <h3>Notes Timeline</h3>
  <form class="form" action="{{ url_for('add_client_note', client_id=client.id) }}" method="POST" style="max-width:700px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label class="label">New note</label>
    <input class="input" name="text" maxlength="500" placeholder="Session focus, injury note, or reminder..." required>

    {% if is_admin %}
      <label class="label" style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" name="is_private" value="1">
        Private note (coach only)
      </label>
    {% endif %}

    <button class="btn" type="submit">Add Note</button>
  </form>

  {% if notes %}
    <div class="table-wrap" style="margin-top:10px;">
      <table>
        <tr>
          <th>Date</th>
          <th>By</th>
          <th>Visibility</th>
          <th>Note</th>
          <th></th>
        </tr>
        {% for n in notes %}
          <tr>
            <td>{{ n.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
            <td>{{ n.created_by_role }}</td>
            <td>{% if n.is_private %}Private{% else %}Shared{% endif %}</td>
            <td>{{ n.text }}</td>
            <td style="text-align:right;">
              {% if is_admin %}
                <form action="{{ url_for('delete_client_note', client_id=client.id, note_id=n.id) }}"
                      method="POST"
                      onsubmit="return confirm('Delete this note?');"
                      style="margin:0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn danger" type="submit">Delete</button>
                </form>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
  {% else %}
    <div class="empty-state" style="margin-top:10px;">No notes yet.</div>
  {% endif %}
</div>
