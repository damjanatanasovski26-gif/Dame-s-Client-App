<div class="card">
  <h3>Sessions</h3>

  <div class="muted" style="margin-bottom:10px;">
    This week: <b>{{ used_this_week }}</b> / <b>{{ allowed }}</b>
    (Remaining: <b>{{ remaining }}</b>)
  </div>

  <form id="logSessionForm" class="form" action="{{ url_for('add_session', client_id=client.id) }}" method="POST" style="max-width:520px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label class="label">Session date (optional, defaults to today)</label>
    <input class="input" type="date" name="session_date">
    <input class="input" name="note" placeholder="Optional note (Push / Pull / Rehab)">
    <button class="btn" type="submit">Log Session</button>
  </form>
</div>

<div class="card">
  <h3>Session Calendar - {{ session_calendar.month_name }} {{ session_calendar.year }}</h3>
  <div class="session-calendar">
    {% for label in session_calendar.weekday_labels %}
      <div class="session-calendar-head">{{ label }}</div>
    {% endfor %}
    {% for cell in session_calendar.cells %}
      <div
        class="session-calendar-cell {% if cell.is_today %}today{% endif %} {% if cell.count > 0 %}has-session{% endif %} {% if cell.day %}clickable{% endif %}"
        {% if cell.day %}
          data-calendar-day="{{ '%04d-%02d-%02d'|format(session_calendar.year, session_calendar.month, cell.day) }}"
        {% endif %}
      >
        {% if cell.day %}
          <div class="session-calendar-day">{{ cell.day }}</div>
          {% if cell.count > 0 %}
            <div class="session-calendar-count">{{ cell.count }} session{% if cell.count != 1 %}s{% endif %}</div>
          {% else %}
            <div class="session-calendar-empty">-</div>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<div class="card">
  <h3>Appointments</h3>
  <div class="actions" style="margin-bottom:10px;">
    <button id="openAppointmentModalBtn" class="btn secondary" type="button">Schedule Appointment</button>
  </div>

  <form class="form" action="{{ url_for('add_appointment', client_id=client.id) }}" method="POST" style="max-width:620px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label class="label">Date & time</label>
    <input class="input" type="datetime-local" name="scheduled_for" required>
    <label class="label">Note</label>
    <input class="input" name="note" maxlength="200" placeholder="Optional appointment note">
    <button class="btn" type="submit">{% if is_admin %}Add Appointment{% else %}Request Appointment{% endif %}</button>
  </form>

  {% if appointments %}
    <div class="table-wrap" style="margin-top:10px;">
      <table>
        <tr>
          <th>Date</th>
          <th>Status</th>
          <th>Note</th>
          <th>Created By</th>
          <th></th>
        </tr>
        {% for a in appointments %}
          <tr>
            <td>{{ a.scheduled_for.strftime("%d/%m/%Y %H:%M") }}</td>
            <td>{{ a.status }}</td>
            <td>{{ a.note or "-" }}</td>
            <td>{{ a.created_by_role }}</td>
            <td style="text-align:right;">
              {% if is_admin %}
                <form action="{{ url_for('update_appointment_status', client_id=client.id, appointment_id=a.id) }}" method="POST" style="display:flex; gap:6px; align-items:center; margin:0 0 6px 0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <select class="input" name="status" style="max-width:130px;">
                    <option value="requested" {% if a.status=='requested' %}selected{% endif %}>requested</option>
                    <option value="confirmed" {% if a.status=='confirmed' %}selected{% endif %}>confirmed</option>
                    <option value="completed" {% if a.status=='completed' %}selected{% endif %}>completed</option>
                    <option value="cancelled" {% if a.status=='cancelled' %}selected{% endif %}>cancelled</option>
                  </select>
                  <button class="btn secondary" type="submit">Save</button>
                </form>
                <form action="{{ url_for('delete_appointment', client_id=client.id, appointment_id=a.id) }}" method="POST" onsubmit="return confirm('Delete this appointment?');" style="margin:0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn danger" type="submit">Delete</button>
                </form>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
  {% else %}
    <div class="empty-state" style="margin-top:10px;">No appointments yet.</div>
  {% endif %}
</div>

<div id="calendarAppointmentModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card">
    <h3 style="margin-bottom:8px;">Schedule Appointment</h3>
    <form class="form" action="{{ url_for('add_appointment', client_id=client.id) }}" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label class="label">Date & time</label>
      <input id="calendarAppointmentDatetime" class="input" type="datetime-local" name="scheduled_for" required>
      <label class="label">Note</label>
      <input class="input" name="note" maxlength="200" placeholder="Optional appointment note">
      <div class="actions">
        <button class="btn" type="submit">{% if is_admin %}Add Appointment{% else %}Request Appointment{% endif %}</button>
        <button id="closeAppointmentModalBtn" class="btn secondary" type="button">Close</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    const modal = document.getElementById("calendarAppointmentModal");
    const datetimeInput = document.getElementById("calendarAppointmentDatetime");
    const closeBtn = document.getElementById("closeAppointmentModalBtn");
    const openBtn = document.getElementById("openAppointmentModalBtn");
    if (!modal || !datetimeInput || !closeBtn || !openBtn) return;

    function openModal(dateStr) {
      if (dateStr) {
        // Keep existing time if user already picked one, otherwise default 09:00
        const current = datetimeInput.value || "";
        const existingTime = current.includes("T") ? current.split("T")[1] : "";
        const timePart = existingTime || "09:00";
        datetimeInput.value = dateStr + "T" + timePart;
      } else if (!datetimeInput.value) {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, "0");
        const d = String(now.getDate()).padStart(2, "0");
        datetimeInput.value = y + "-" + m + "-" + d + "T09:00";
      }
      modal.classList.add("show");
      modal.setAttribute("aria-hidden", "false");
      datetimeInput.focus();
    }

    function closeModal() {
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
    }

    openBtn.addEventListener("click", function () {
      openModal("");
    });

    closeBtn.addEventListener("click", closeModal);

    modal.addEventListener("click", function (e) {
      if (e.target === modal) closeModal();
    });

    document.querySelectorAll("[data-calendar-day]").forEach(function (cell) {
      cell.addEventListener("click", function () {
        openModal(cell.getAttribute("data-calendar-day"));
      });
    });
  })();
</script>

<div class="card">
  <h3>Recent Sessions</h3>

  {% if sessions %}
    <div class="table-wrap">
      <table>
        <tr>
          <th>Date</th>
          <th>Note</th>
          <th></th>
        </tr>
        {% for s in sessions %}
        <tr>
          <td>{{ s.date.strftime("%d/%m/%Y %H:%M") }}</td>
          <td>{{ s.note or "-" }}</td>
          <td style="text-align:right;">
            {% if is_admin %}
              <form action="{{ url_for('delete_session', client_id=client.id, session_id=s.id) }}"
                    method="POST"
                    onsubmit="return confirm('Delete this session?');"
                    style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn danger" type="submit">Delete</button>
              </form>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>
  {% else %}
    <div class="empty-state">No sessions logged yet.</div>
  {% endif %}
</div>
