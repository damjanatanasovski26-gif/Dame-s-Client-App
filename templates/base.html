<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1f33" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Trainer App" />
  <title>{{ title or "Trainer App" }}</title>
  <link rel="manifest" href="{{ url_for('pwa_manifest') }}?v=2">
  <link rel="icon" href="{{ url_for('static', filename='images/barbell.png') }}?v=2">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/barbell.png') }}?v=2">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="{{ page_class or '' }}">
  <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle dark mode">
    <span class="theme-icon sun" aria-hidden="true">&#9728;</span>
    <span class="theme-icon moon" aria-hidden="true">&#9790;</span>
  </button>
  <button id="installAppBtn" class="install-app-btn" type="button" hidden>Install App</button>
  <div id="installHelpToast" class="install-help-toast" hidden></div>
  <div class="container">
    {% block content %}{% endblock %}
  </div>
  <script>
    (function () {
      const key = "trainer_theme";
      const root = document.documentElement;
      const toggle = document.getElementById("themeToggle");

      function getPreferredTheme() {
        const stored = localStorage.getItem(key);
        if (stored === "light" || stored === "dark") return stored;
        return "dark";
      }

      function applyTheme(theme) {
        root.classList.add("theme-transition");
        root.setAttribute("data-theme", theme);
        window.setTimeout(function () {
          root.classList.remove("theme-transition");
        }, 280);
        if (toggle) {
          toggle.setAttribute("title", theme === "dark" ? "Switch to light mode" : "Switch to dark mode");
          toggle.setAttribute("aria-label", theme === "dark" ? "Switch to light mode" : "Switch to dark mode");
        }
      }

      const initial = getPreferredTheme();
      applyTheme(initial);

      if (toggle) {
        toggle.addEventListener("click", function () {
          const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
          localStorage.setItem(key, next);
          applyTheme(next);
        });
      }
    })();

    (function () {
      const toggles = document.querySelectorAll("[data-password-target]");
      toggles.forEach(function (toggle) {
        const targetId = toggle.getAttribute("data-password-target");
        if (!targetId) return;
        const input = document.getElementById(targetId);
        if (!input) return;

        function setVisible(isVisible) {
          if (toggle.disabled || input.disabled) return;
          input.type = isVisible ? "text" : "password";
          toggle.setAttribute("aria-pressed", isVisible ? "true" : "false");
          toggle.setAttribute("aria-label", isVisible ? "Hide password" : "Show password");
        }

        toggle.addEventListener("mouseenter", function () { setVisible(true); });
        toggle.addEventListener("mouseleave", function () {
          if (toggle.getAttribute("aria-pressed") !== "true") setVisible(false);
        });
        toggle.addEventListener("focus", function () { setVisible(true); });
        toggle.addEventListener("blur", function () {
          if (toggle.getAttribute("aria-pressed") !== "true") setVisible(false);
        });
        toggle.addEventListener("click", function () {
          const nowPressed = toggle.getAttribute("aria-pressed") === "true";
          setVisible(!nowPressed);
        });
      });
    })();

    (function () {
      if (!("serviceWorker" in navigator)) return;
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("{{ url_for('pwa_service_worker') }}").catch(function () {
          // SW registration is optional; ignore failures.
        });
      });
    })();

    (function () {
      const btn = document.getElementById("installAppBtn");
      const toast = document.getElementById("installHelpToast");
      if (!btn || !toast) return;

      let deferredPrompt = null;
      const ua = navigator.userAgent || "";
      const isIos = /iPad|iPhone|iPod/.test(ua);
      const isSafari = isIos && /Safari/.test(ua) && !/CriOS|FxiOS|EdgiOS/.test(ua);
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches
        || window.navigator.standalone === true;

      function showToast(message) {
        toast.textContent = message;
        toast.hidden = false;
        toast.classList.add("show");
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(function () {
          toast.classList.remove("show");
          window.setTimeout(function () { toast.hidden = true; }, 180);
        }, 2800);
      }

      function showButton() {
        if (isStandalone) return;
        btn.hidden = false;
      }

      window.addEventListener("beforeinstallprompt", function (e) {
        e.preventDefault();
        deferredPrompt = e;
        showButton();
      });

      if (isSafari && !isStandalone) {
        showButton();
      }

      btn.addEventListener("click", async function () {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          try { await deferredPrompt.userChoice; } catch (_) {}
          deferredPrompt = null;
          btn.hidden = true;
          return;
        }
        if (isSafari && !isStandalone) {
          showToast("Safari: tap Share, then Add to Home Screen.");
          return;
        }
        showToast("Install option may appear in your browser menu.");
      });
    })();
  </script>
</body>
</html>
