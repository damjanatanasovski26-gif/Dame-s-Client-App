<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f1f33" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Damjan's Client App" />
  <title>{{ title or "Damjan's Client App" }}</title>
  <link rel="manifest" href="{{ url_for('pwa_manifest') }}?v=3">
  <link rel="icon" href="{{ url_for('static', filename='images/barbell.png') }}?v=2">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/barbell.png') }}?v=2">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="{{ page_class or '' }}">
  <button id="themeToggle" class="theme-toggle" type="button" aria-label="Toggle dark mode">
    <span class="theme-icon sun" aria-hidden="true">&#9728;</span>
    <span class="theme-icon moon" aria-hidden="true">&#9790;</span>
  </button>
  <button id="installAppBtn" class="install-app-btn" type="button" hidden>Install App</button>
  <div id="installPromptModal" class="modal-backdrop install-modal-backdrop" hidden>
    <div class="modal-card install-modal-card" role="dialog" aria-modal="true" aria-labelledby="installPromptTitle">
      <h3 id="installPromptTitle">Install Damjan's Client App?</h3>
      <p id="installPromptMessage" class="muted install-modal-text">
        Add Damjan's Client App to your home screen for faster access and an app-like experience.
      </p>
      <div class="actions install-modal-actions">
        <button id="installPromptConfirm" type="button" class="btn">Yes, Install</button>
        <button id="installPromptLater" type="button" class="btn secondary">Maybe Later</button>
      </div>
    </div>
  </div>
  <div id="installHelpToast" class="install-help-toast" hidden></div>
  <div class="container">
    {% block content %}{% endblock %}
  </div>
  <script>
    (function () {
      const key = "trainer_theme";
      const root = document.documentElement;
      const toggle = document.getElementById("themeToggle");

      function getPreferredTheme() {
        const stored = localStorage.getItem(key);
        if (stored === "light" || stored === "dark") return stored;
        return "dark";
      }

      function applyTheme(theme) {
        root.classList.add("theme-transition");
        root.setAttribute("data-theme", theme);
        window.setTimeout(function () {
          root.classList.remove("theme-transition");
        }, 280);
        if (toggle) {
          toggle.setAttribute("title", theme === "dark" ? "Switch to light mode" : "Switch to dark mode");
          toggle.setAttribute("aria-label", theme === "dark" ? "Switch to light mode" : "Switch to dark mode");
        }
      }

      const initial = getPreferredTheme();
      applyTheme(initial);

      if (toggle) {
        toggle.addEventListener("click", function () {
          const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
          localStorage.setItem(key, next);
          applyTheme(next);
        });
      }
    })();

    (function () {
      const toggles = document.querySelectorAll("[data-password-target]");
      toggles.forEach(function (toggle) {
        const targetId = toggle.getAttribute("data-password-target");
        if (!targetId) return;
        const input = document.getElementById(targetId);
        if (!input) return;

        function setVisible(isVisible) {
          if (toggle.disabled || input.disabled) return;
          input.type = isVisible ? "text" : "password";
          toggle.setAttribute("aria-pressed", isVisible ? "true" : "false");
          toggle.setAttribute("aria-label", isVisible ? "Hide password" : "Show password");
        }

        toggle.addEventListener("mouseenter", function () { setVisible(true); });
        toggle.addEventListener("mouseleave", function () {
          if (toggle.getAttribute("aria-pressed") !== "true") setVisible(false);
        });
        toggle.addEventListener("focus", function () { setVisible(true); });
        toggle.addEventListener("blur", function () {
          if (toggle.getAttribute("aria-pressed") !== "true") setVisible(false);
        });
        toggle.addEventListener("click", function () {
          const nowPressed = toggle.getAttribute("aria-pressed") === "true";
          setVisible(!nowPressed);
        });
      });
    })();

    (function () {
      if (!("serviceWorker" in navigator)) return;
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("{{ url_for('pwa_service_worker') }}").catch(function () {
          // SW registration is optional; ignore failures.
        });
      });
    })();

    (function () {
      const btn = document.getElementById("installAppBtn");
      const toast = document.getElementById("installHelpToast");
      const modal = document.getElementById("installPromptModal");
      const modalMessage = document.getElementById("installPromptMessage");
      const confirmBtn = document.getElementById("installPromptConfirm");
      const laterBtn = document.getElementById("installPromptLater");
      if (!btn || !toast || !modal || !modalMessage || !confirmBtn || !laterBtn) return;

      let deferredPrompt = null;
      const ua = navigator.userAgent || "";
      const isIos = /iPad|iPhone|iPod/.test(ua);
      const isSafari = isIos && /Safari/.test(ua) && !/CriOS|FxiOS|EdgiOS/.test(ua);
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches
        || window.navigator.standalone === true;
      const promptDismissKey = "pwa_install_prompt_dismissed_until_v1";
      let autoPromptShown = false;

      function showToast(message) {
        toast.textContent = message;
        toast.hidden = false;
        toast.classList.add("show");
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(function () {
          toast.classList.remove("show");
          window.setTimeout(function () { toast.hidden = true; }, 180);
        }, 2800);
      }

      function showButton() {
        if (isStandalone) return;
        btn.hidden = false;
      }

      function canShowAutoPrompt() {
        if (isStandalone) return false;
        const until = Number(localStorage.getItem(promptDismissKey) || "0");
        return !until || Date.now() > until;
      }

      function dismissAutoPrompt(days) {
        const ms = (days || 7) * 24 * 60 * 60 * 1000;
        localStorage.setItem(promptDismissKey, String(Date.now() + ms));
      }

      function openModal() {
        if (isStandalone) return;
        modal.hidden = false;
        modal.classList.add("show");
      }

      function closeModal() {
        modal.classList.remove("show");
        window.setTimeout(function () {
          if (!modal.classList.contains("show")) modal.hidden = true;
        }, 140);
      }

      function updateModalMessage() {
        if (deferredPrompt) {
          modalMessage.textContent = "Add Damjan's Client App to your home screen for faster access and an app-like experience.";
          confirmBtn.textContent = "Yes, Install";
          return;
        }
        if (isSafari && !isStandalone) {
          modalMessage.textContent = "On iPhone/iPad, tap Share and then Add to Home Screen to install Damjan's Client App.";
          confirmBtn.textContent = "Show Me How";
          return;
        }
        modalMessage.textContent = "Your browser may show the install option in its menu. We can try opening it now.";
        confirmBtn.textContent = "Open Install Option";
      }

      function maybeOpenAutoPrompt() {
        if (autoPromptShown || !canShowAutoPrompt()) return;
        if (!(deferredPrompt || (isSafari && !isStandalone))) return;
        autoPromptShown = true;
        updateModalMessage();
        openModal();
      }

      window.addEventListener("beforeinstallprompt", function (e) {
        e.preventDefault();
        deferredPrompt = e;
        showButton();
        maybeOpenAutoPrompt();
      });

      if (isSafari && !isStandalone) {
        showButton();
        window.setTimeout(maybeOpenAutoPrompt, 350);
      }

      async function handleInstallConfirm() {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          try {
            const choice = await deferredPrompt.userChoice;
            if (choice && choice.outcome === "accepted") {
              btn.hidden = true;
              closeModal();
              return;
            }
          } catch (_) {}
          deferredPrompt = null;
          dismissAutoPrompt(7);
          closeModal();
          return;
        }
        if (isSafari && !isStandalone) {
          showToast("Safari: tap Share, then Add to Home Screen.");
          dismissAutoPrompt(7);
          closeModal();
          return;
        }
        showToast("Install option may appear in your browser menu.");
        dismissAutoPrompt(7);
        closeModal();
      }

      btn.addEventListener("click", function () {
        updateModalMessage();
        openModal();
      });

      confirmBtn.addEventListener("click", function () {
        handleInstallConfirm();
      });

      laterBtn.addEventListener("click", function () {
        dismissAutoPrompt(7);
        closeModal();
      });

      modal.addEventListener("click", function (e) {
        if (e.target !== modal) return;
        dismissAutoPrompt(3);
        closeModal();
      });

      window.addEventListener("appinstalled", function () {
        btn.hidden = true;
        closeModal();
      });
    })();
  </script>
</body>
</html>
