{% extends "base.html" %}
{% set title = "Dashboard" %}

{% block content %}
<div class="topbar">
  <h1>Dame's Client App</h1>
  <a href="{{ url_for('logout') }}" class="btn danger">Log out</a>
</div>

{% if err %}
  <div class="alert error" style="margin-bottom:14px;">
    <b style="color:var(--danger);">Error:</b> {{ err }}
  </div>
{% endif %}

{% if msg %}
  <div class="alert success" style="margin-bottom:14px;">
    <b style="color:var(--success);">OK:</b> {{ msg }}
  </div>
{% endif %}

<div class="card">
  <h3>Data Tools</h3>
  <div class="actions">
    <a class="btn secondary" href="{{ url_for('export_clients_csv') }}">Export Clients CSV</a>
    <a class="btn secondary" href="{{ url_for('export_sessions_csv') }}">Export Sessions CSV</a>
    <a class="btn secondary" href="{{ url_for('export_payments_csv') }}">Export Payments CSV</a>
    <a class="btn" href="{{ url_for('backup_database') }}">Download DB Backup</a>
  </div>
</div>

<div class="card">
  <h3>Payment Alerts</h3>
  {% if payment_alerts %}
    {% for alert in payment_alerts %}
      <div class="client-row">
        <div>
          <div class="client-name">{{ alert.client.name }}</div>
          <div class="muted">
            Status:
            <span class="payment-badge payment-badge-{{ alert.tone }}">{{ alert.label }}</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <a class="btn secondary" href="{{ url_for('client_profile', client_id=alert.client.id, tab='payments') }}">Open Payments</a>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">No due-soon or overdue payments right now.</div>
  {% endif %}
</div>

<div class="card">
  <h3>Admin Credentials</h3>
  <form class="form" action="{{ url_for('change_admin_credentials') }}" method="POST" style="max-width:720px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <label class="label">Current Password</label>
    <div class="password-wrap">
      <input id="adminCurrentPassword" class="input" type="password" name="current_password" autocomplete="current-password" required>
      <button class="password-toggle" type="button" data-password-target="adminCurrentPassword" aria-label="Show password" aria-pressed="false">&#128065;</button>
    </div>

    <label class="label" style="margin-top:12px;">New Username</label>
    <input class="input" name="new_username" autocomplete="username" pattern="[A-Za-z0-9._-]+" title="Use letters, numbers, dot, underscore, or hyphen." required>

    <label class="label" style="margin-top:12px;">New Password (optional)</label>
    <div class="password-wrap">
      <input id="adminNewPassword" class="input" type="password" name="new_password" autocomplete="new-password" minlength="6">
      <button class="password-toggle" type="button" data-password-target="adminNewPassword" aria-label="Show password" aria-pressed="false">&#128065;</button>
    </div>

    <label class="label" style="margin-top:12px;">Confirm New Password</label>
    <div class="password-wrap">
      <input id="adminConfirmPassword" class="input" type="password" name="confirm_password" autocomplete="new-password" minlength="6">
      <button class="password-toggle" type="button" data-password-target="adminConfirmPassword" aria-label="Show password" aria-pressed="false">&#128065;</button>
    </div>

    <button class="btn" type="submit" style="margin-top:14px;">Update Admin Credentials</button>
  </form>
</div>

<div class="card">
  <h3>Add Client</h3>
  <form class="form add-client-form" action="{{ url_for('add_client') }}" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="add-client-grid">
      <div class="field-span-2">
        <label class="label">Client Name</label>
        <input class="input" name="name" placeholder="e.g. John Doe" required>
      </div>

      <div>
        <label class="label">Phone</label>
        <input class="input" name="phone" placeholder="+389..." inputmode="tel" pattern="\+?\d*" title="Use only digits and optional leading +">
      </div>

      <div>
        <label class="label">Training Plan</label>
        <input class="input" name="plan" placeholder="e.g. Arnold Split">
      </div>
    </div>
    <button class="btn add-client-btn" type="submit">Add Client</button>
  </form>
</div>

<div class="card">
  <h3>Your Clients</h3>

  {% if clients %}
    {% for c in clients %}
      <div class="client-row">
        <div>
          <div class="client-name">{{ c.name }}</div>
          <div class="muted">
            Phone: {{ c.phone or "-" }} | Plan: {{ c.plan or "-" }}
          </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <a href="{{ url_for('client_profile', client_id=c.id) }}" class="btn">Open Profile</a>
          <form action="{{ url_for('delete_client', client_id=c.id) }}" method="POST"
                onsubmit="return confirm('Delete {{ c.name }}?');" style="margin:0;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn danger" type="submit">Delete</button>
          </form>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">No clients yet. Add your first client above.</div>
  {% endif %}
</div>
{% endblock %}
